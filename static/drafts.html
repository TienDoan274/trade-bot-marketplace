<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Draft Bots</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" href="/static/favicon.ico">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/static/dev_sandbox_v2.html"><i class="fas fa-robot"></i> Developer</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMain" aria-controls="navbarsMain" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarsMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/static/dev_sandbox_v2.html"><i class="fas fa-flask"></i> Dev Sandbox</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="/static/drafts.html"><i class="fas fa-save"></i> Drafts</a></li>
          <li class="nav-item"><a class="nav-link" href="/static/submit_bot.html"><i class="fas fa-upload"></i> Submit Bot</a></li>
          <li class="nav-item"><a class="nav-link" href="https://github.com/TienDoan274/trade-bot-marketplace" target="_blank" rel="noopener"><i class="fab fa-github"></i> GitHub</a></li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-user"></i> <span id="navUserEmail">Developer</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="/static/dev_sandbox_v2.html">Dev Sandbox</a></li>
              <li><a class="dropdown-item" href="/static/drafts.html">Drafts</a></li>
              <li><a class="dropdown-item" href="/static/submit_bot.html">Submit Bot</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div id="msg" class="mb-3 text-muted"></div>

    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="card-title mb-0">Your Drafts</h5>
          <div>
            <button class="btn btn-sm btn-outline-info me-2" onclick="saveUserInfo()">Save User Info</button>
            <button class="btn btn-sm btn-outline-warning me-2" onclick="relogin()">Re-login</button>
            <button class="btn btn-sm btn-primary" onclick="refreshDrafts()">Refresh</button>
          </div>
        </div>
        <div id="draftList"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/dev-sandbox';
    let token = '';

    window.addEventListener('load', () => {
      const t = localStorage.getItem('access_token');
      const userId = localStorage.getItem('user_id');
      const userEmail = localStorage.getItem('user_email');
      
      console.log('DEBUG: Token:', t ? 'Present' : 'Missing');
      console.log('DEBUG: User ID:', userId);
      console.log('DEBUG: User Email:', userEmail);
      
      if (!t) {
        // In development mode, use a test token
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          token = 'test';
          console.log('Using development test token');
        } else {
          const next = encodeURIComponent('/static/drafts.html');
          window.location.href = `/static/login.html?next=${next}`;
          return;
        }
      } else {
        token = t;
      }
      
      // If we have a token but no user_id, try to decode it and save user info
      if (token && token !== 'test' && !userId) {
        console.log('No user_id in localStorage, decoding token...');
        decodeAndSaveUserInfo();
      } else {
        // Update user display
        if (userEmail) {
          document.getElementById('navUserEmail').textContent = userEmail;
        }
        refreshDrafts();
      }
    });
    
    async function decodeAndSaveUserInfo() {
      try {
        const resp = await fetch(`${API_BASE}/decode-token`, { headers: headers() });
        const data = await resp.json();
        console.log('Decode result for saving:', data);
        
        if (data.success && data.user_id) {
          localStorage.setItem('user_id', data.user_id);
          console.log('Saved user_id from token:', data.user_id);
          
          // Try to get user email from debug endpoint
          const userResp = await fetch(`${API_BASE}/debug-user`, { headers: headers() });
          const userData = await userResp.json();
          if (userData.success && userData.user_info.email) {
            localStorage.setItem('user_email', userData.user_info.email);
            console.log('Saved user_email:', userData.user_info.email);
            document.getElementById('navUserEmail').textContent = userData.user_info.email;
          }
        }
      } catch (e) {
        console.error('Error decoding token for saving:', e);
      }
      
      // Continue with loading drafts
      refreshDrafts();
    }

    function headers() { 
      // Always send Authorization header if token is available
      if (token && token !== 'test') {
        return { 'Authorization': `Bearer ${token}` };
      }
      return {}; 
    }
    function setMsg(m, err=false) {
      const el = document.getElementById('msg');
      el.textContent = m; el.className = err ? 'mb-3 text-danger' : 'mb-3 text-muted';
    }

    async function refreshDrafts() {
      try {
        setMsg('Loading drafts...');
        
        // First test the current token
        console.log('Testing current token...');
        const tokenResp = await fetch(`${API_BASE}/test-token`, { headers: headers() });
        const tokenData = await tokenResp.json();
        console.log('Token test result:', tokenData);
        
        // First decode the token to see what user_id it contains
        console.log('Decoding token...');
        const decodeResp = await fetch(`${API_BASE}/decode-token`, { headers: headers() });
        const decodeData = await decodeResp.json();
        console.log('Token decode result:', decodeData);
        
        // Test user authentication
        console.log('Testing user authentication...');
        const userResp = await fetch(`${API_BASE}/debug-user`, { headers: headers() });
        const userData = await userResp.json();
        console.log('User debug result:', userData);
        
        const resp = await fetch(`${API_BASE}/list-saved-bots`, { headers: headers() });
        const data = await resp.json();
        console.log('API Response:', data); // Debug log
        if (!resp.ok || !data.success) { 
          setMsg('Failed to load drafts: ' + (data.message || 'Unknown error'), true); 
          return; 
        }
        const drafts = data.drafts || data.bots || []; // Try both fields
        console.log('Drafts found:', drafts); // Debug log
        renderDrafts(drafts);
        setMsg(`Loaded ${drafts.length} drafts`);
      } catch (e) { 
        console.error('Error loading drafts:', e); // Debug log
        setMsg('Error: ' + e.message, true); 
      }
    }

    function renderDrafts(items) {
      const c = document.getElementById('draftList');
      c.innerHTML = '';
      if (!items.length) { c.innerHTML = '<p class="text-muted">No drafts yet.</p>'; return; }
      items.forEach(d => {
        const row = document.createElement('div');
        row.className = 'border rounded p-2 mb-2';
        row.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${escapeHtml(d.name || 'Untitled')}</strong>
              <div><small class="text-muted">${escapeHtml(d.description || '')} â€¢ Created: ${escapeHtml(d.created_at || '')}</small></div>
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="openInSandbox(${d.id})">Open in Sandbox</button>
              <button class="btn btn-outline-success" onclick="submitDraft(${d.id})">Submit</button>
              <button class="btn btn-outline-danger" onclick="deleteDraft(${d.id})">Delete</button>
            </div>
          </div>`;
        c.appendChild(row);
      });
    }

    function openInSandbox(draftId) {
      window.location.href = `/static/dev_sandbox_v2.html?draft=${draftId}`;
    }

    async function submitDraft(draftId) {
      // Navigate to the Submit Bot page carrying this draft ID
      window.location.href = `/static/submit_bot.html?draft=${draftId}`;
    }

    async function deleteDraft(draftId) {
      if (!confirm('Delete this draft?')) return;
      const resp = await fetch(`${API_BASE}/delete-bot-code/${draftId}`, { method: 'DELETE', headers: headers() });
      if (resp.ok) { refreshDrafts(); } else { alert('Delete failed'); }
    }

    function gotoSandbox() { window.location.href = '/static/dev_sandbox_v2.html'; }
    function logout() { localStorage.removeItem('access_token'); window.location.href = '/static/login.html'; }
    function relogin() { 
      localStorage.removeItem('access_token'); 
      localStorage.removeItem('user_id'); 
      localStorage.removeItem('user_email'); 
      window.location.href = '/static/login.html'; 
    }
    function saveUserInfo() {
      decodeAndSaveUserInfo();
    }
    function escapeHtml(s) { return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 